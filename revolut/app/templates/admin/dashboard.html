<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poll Management Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        .poll-card {
            transition: transform 0.2s;
        }
        .poll-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .poll-status {
            font-size: 0.875rem;
            font-weight: 600;
        }
        .option-bar {
            height: 20px;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .vote-count {
            font-size: 0.875rem;
            color: #6c757d;
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 0.375rem;
            border: 1px solid #f5c2c7;
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-pie-chart me-2"></i>Poll Management</h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary" onclick="refreshPolls()">
                            <i class="bi bi-arrow-clockwise me-2"></i>Refresh
                        </button>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createPollModal">
                            <i class="bi bi-plus-circle me-2"></i>Create Poll
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6>Total Polls</h6>
                                        <h3 id="totalPolls">0</h3>
                                    </div>
                                    <i class="bi bi-pie-chart fs-1 opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6>Active Polls</h6>
                                        <h3 id="activePolls">0</h3>
                                    </div>
                                    <i class="bi bi-check-circle fs-1 opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6>Total Votes</h6>
                                        <h3 id="totalVotes">0</h3>
                                    </div>
                                    <i class="bi bi-people fs-1 opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6>Expired Polls</h6>
                                        <h3 id="expiredPolls">0</h3>
                                    </div>
                                    <i class="bi bi-clock-history fs-1 opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Error Display -->
                <div id="errorDisplay" class="error-message d-none mb-4">
                    <strong>Error:</strong> <span id="errorMessage"></span>
                </div>

                <!-- Polls List -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">All Polls</h5>
                    </div>
                    <div class="card-body">
                        <div id="loadingSpinner" class="text-center py-4">
                            <div class="loading-spinner me-2"></div>
                            Loading polls...
                        </div>
                        <div id="pollsList" class="d-none">
                            <!-- Polls will be loaded here -->
                        </div>
                        <div id="noPolls" class="text-center py-4 d-none">
                            <i class="bi bi-pie-chart fs-1 text-muted"></i>
                            <p class="text-muted mt-2">No polls found. Create your first poll!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Poll Modal -->
    <div class="modal fade" id="createPollModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Poll</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createPollForm">
                        <div class="mb-3">
                            <label for="pollQuestion" class="form-label">Poll Question *</label>
                            <textarea class="form-control" id="pollQuestion" rows="3" placeholder="What would you like to ask citizens about?" required></textarea>
                            <div class="form-text">Minimum 10 characters, maximum 500 characters</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Poll Options *</label>
                            <div id="pollOptions">
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control poll-option" placeholder="Option 1" required>
                                </div>
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control poll-option" placeholder="Option 2" required>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addPollOption()">
                                <i class="bi bi-plus"></i> Add Option
                            </button>
                            <div class="form-text">Minimum 2 options, maximum 6 options</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="pollDuration" class="form-label">Duration</label>
                            <select class="form-select" id="pollDuration">
                                <option value="1">1 day</option>
                                <option value="3">3 days</option>
                                <option value="7" selected>7 days</option>
                                <option value="14">14 days</option>
                                <option value="30">30 days</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="notifyCitizens" checked>
                                <label class="form-check-label" for="notifyCitizens">
                                    Notify citizens via SMS
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createPoll()">
                        <i class="bi bi-plus-circle me-2"></i>Create Poll
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let allPolls = [];
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadPolls();
        });

        // Error handling
        function showError(message) {
            console.error('Error:', message);
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorDisplay').classList.remove('d-none');
        }

        function hideError() {
            document.getElementById('errorDisplay').classList.add('d-none');
        }

        // Load polls from API
        async function loadPolls() {
            try {
                hideError();
                document.getElementById('loadingSpinner').classList.remove('d-none');
                document.getElementById('pollsList').classList.add('d-none');
                document.getElementById('noPolls').classList.add('d-none');

                // Try different API endpoints based on user role
                let response;
                try {
                    // First try the admin polls results endpoint
                    response = await fetch('/api/polls/results');
                } catch (e) {
                    // Fallback to regular polls endpoint
                    response = await fetch('/api/polls');
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('API Response:', data);

                // Handle different response formats
                let polls = [];
                if (data.polls && Array.isArray(data.polls)) {
                    polls = data.polls;
                } else if (Array.isArray(data)) {
                    polls = data;
                } else {
                    throw new Error('Invalid response format: expected polls array');
                }

                allPolls = polls;
                displayPolls(polls);
                updateStats(polls);

            } catch (error) {
                console.error('Failed to load polls:', error);
                showError(`Failed to load polls: ${error.message}`);
            } finally {
                document.getElementById('loadingSpinner').classList.add('d-none');
            }
        }

        // Display polls in the UI
        function displayPolls(polls) {
            const pollsList = document.getElementById('pollsList');
            const noPolls = document.getElementById('noPolls');

            if (!polls || polls.length === 0) {
                pollsList.classList.add('d-none');
                noPolls.classList.remove('d-none');
                return;
            }

            pollsList.classList.remove('d-none');
            noPolls.classList.add('d-none');

            pollsList.innerHTML = polls.map(poll => createPollCard(poll)).join('');
        }

        // Create poll card HTML
        function createPollCard(poll) {
            const isActive = poll.is_active || (poll.expires_at && new Date(poll.expires_at) > new Date());
            const statusClass = isActive ? 'success' : 'secondary';
            const statusText = isActive ? 'Active' : 'Expired';
            
            const totalVotes = poll.total_votes || 0;
            const createdAt = poll.created_at ? new Date(poll.created_at).toLocaleDateString() : 'Unknown';
            const expiresAt = poll.expires_at ? new Date(poll.expires_at).toLocaleDateString() : 'No expiry';

            const optionsHtml = (poll.options || []).map(option => {
                const votes = option.votes || 0;
                const percentage = option.percentage || 0;
                return `
                    <div class="mb-2">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="fw-medium">${escapeHtml(option.text || 'Unknown option')}</span>
                            <span class="vote-count">${votes} votes (${percentage}%)</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar option-bar" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card poll-card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span class="badge bg-${statusClass} poll-status">${statusText}</span>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    Actions
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="viewPollDetails(${poll.id})">
                                        <i class="bi bi-eye me-2"></i>View Details
                                    </a></li>
                                    ${isActive ? `
                                        <li><a class="dropdown-item text-warning" href="#" onclick="endPoll(${poll.id})">
                                            <i class="bi bi-stop-circle me-2"></i>End Poll
                                        </a></li>
                                    ` : ''}
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deletePoll(${poll.id})">
                                        <i class="bi bi-trash me-2"></i>Delete
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="card-body">
                            <h6 class="card-title">${escapeHtml(poll.question || 'No question')}</h6>
                            <div class="mb-3">
                                ${optionsHtml}
                            </div>
                            <div class="text-muted small">
                                <div><i class="bi bi-calendar me-1"></i>Created: ${createdAt}</div>
                                <div><i class="bi bi-clock me-1"></i>Expires: ${expiresAt}</div>
                                <div><i class="bi bi-people me-1"></i>Total Votes: ${totalVotes}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Update statistics
        function updateStats(polls) {
            const totalPolls = polls.length;
            const activePolls = polls.filter(poll => poll.is_active || (poll.expires_at && new Date(poll.expires_at) > new Date())).length;
            const expiredPolls = totalPolls - activePolls;
            const totalVotes = polls.reduce((sum, poll) => sum + (poll.total_votes || 0), 0);

            document.getElementById('totalPolls').textContent = totalPolls;
            document.getElementById('activePolls').textContent = activePolls;
            document.getElementById('expiredPolls').textContent = expiredPolls;
            document.getElementById('totalVotes').textContent = totalVotes;
        }

        // Add poll option
        function addPollOption() {
            const container = document.getElementById('pollOptions');
            const optionCount = container.children.length;
            
            if (optionCount < 6) {
                const div = document.createElement('div');
                div.className = 'input-group mb-2';
                div.innerHTML = `
                    <input type="text" class="form-control poll-option" placeholder="Option ${optionCount + 1}" required>
                    <button type="button" class="btn btn-outline-danger" onclick="removePollOption(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                `;
                container.appendChild(div);
            }
        }

        // Remove poll option
        function removePollOption(button) {
            const container = document.getElementById('pollOptions');
            if (container.children.length > 2) {
                button.closest('.input-group').remove();
            }
        }

        // Create new poll
        async function createPoll() {
            try {
                const question = document.getElementById('pollQuestion').value.trim();
                const options = Array.from(document.querySelectorAll('.poll-option'))
                    .map(input => input.value.trim())
                    .filter(option => option);
                const duration = parseInt(document.getElementById('pollDuration').value);
                const notifyCitizens = document.getElementById('notifyCitizens').checked;

                // Validation
                if (question.length < 10) {
                    alert('Poll question must be at least 10 characters long');
                    return;
                }

                if (options.length < 2) {
                    alert('Poll must have at least 2 options');
                    return;
                }

                const response = await fetch('/api/polls', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: question,
                        options: options,
                        duration_days: duration,
                        notify_citizens: notifyCitizens
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    alert('Poll created successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('createPollModal')).hide();
                    document.getElementById('createPollForm').reset();
                    // Reset options to default 2
                    const container = document.getElementById('pollOptions');
                    container.innerHTML = `
                        <div class="input-group mb-2">
                            <input type="text" class="form-control poll-option" placeholder="Option 1" required>
                        </div>
                        <div class="input-group mb-2">
                            <input type="text" class="form-control poll-option" placeholder="Option 2" required>
                        </div>
                    `;
                    loadPolls(); // Refresh the polls list
                } else {
                    const errorMsg = result.errors ? result.errors.join(', ') : result.error || 'Unknown error';
                    alert('Error creating poll: ' + errorMsg);
                }
            } catch (error) {
                console.error('Error creating poll:', error);
                alert('Error creating poll: ' + error.message);
            }
        }

        // View poll details
        function viewPollDetails(pollId) {
            const poll = allPolls.find(p => p.id === pollId);
            if (poll) {
                alert(`Poll Details:\n\nQuestion: ${poll.question}\nTotal Votes: ${poll.total_votes || 0}\nStatus: ${poll.is_active ? 'Active' : 'Expired'}`);
            }
        }

        // Delete poll
        async function deletePoll(pollId) {
            if (confirm('Are you sure you want to delete this poll? This action cannot be undone.')) {
                try {
                    const response = await fetch(`/admin/polls/${pollId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        alert('Poll deleted successfully!');
                        loadPolls(); // Refresh the polls list
                    } else {
                        const result = await response.json();
                        alert('Error deleting poll: ' + (result.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error deleting poll:', error);
                    alert('Error deleting poll: ' + error.message);
                }
            }
        }

        // End poll early
        async function endPoll(pollId) {
            if (confirm('Are you sure you want to end this poll early?')) {
                try {
                    const response = await fetch(`/admin/polls/${pollId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            expires_at: new Date().toISOString()
                        })
                    });

                    if (response.ok) {
                        alert('Poll ended successfully!');
                        loadPolls(); // Refresh the polls list
                    } else {
                        const result = await response.json();
                        alert('Error ending poll: ' + (result.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error ending poll:', error);
                    alert('Error ending poll: ' + error.message);
                }
            }
        }

        // Refresh polls
        function refreshPolls() {
            loadPolls();
        }

        // Utility function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
